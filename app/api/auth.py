from fastapi import APIRouter, Depends
from fastapi.security import HTTPBasicCredentials, OAuth2PasswordRequestForm

from app import schemas
from app.services.auth import (AuthService, get_current_active_superuser,
                               get_current_user)

router = APIRouter(
    prefix="/auth",
    tags=["auth"],
)


@router.post(
    "/access-token/",
    response_model=schemas.Token,
)
def login(
    auth_data: OAuth2PasswordRequestForm = Depends(),
    auth_service: AuthService = Depends(),
):
    return auth_service.authenticate_user(auth_data.username, auth_data.password)


@router.post(
    "/register-user",
    response_model=schemas.Token,
)
def register_user(
    user: schemas.UserCreate,
    current_user: schemas.User = Depends(get_current_active_superuser),  # noqa: F841
    auth_service: AuthService = Depends(),
):
    return auth_service.register_new_user(user)


@router.get(
    "/user/me",
    response_model=schemas.UserWithRole,
)
def get_user(user: schemas.User = Depends(get_current_user)):
    return user
