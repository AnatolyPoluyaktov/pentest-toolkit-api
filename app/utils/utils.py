from whois import whois
from whois.parser import PywhoisError
import socket
from app.schemas.targets.ip import IpCreate, IpwithWhois
from ipaddress import IPv4Address, IPv6Address
from ipwhois import IPWhois
from typing import List


def get_whois(domain: str):
    try:
        info = whois(domain)
    except PywhoisError:
        return "-"
    return info.get("org", "-")


def ips_from_domain(domain: str, project_id: int) -> list[IpCreate]:
    try:
        _, _, ips = socket.gethostbyname_ex(domain)
    except socket.gaierror:
        return []

    return [IpCreate(ip=IPv4Address(ip), project_id=project_id) for ip in ips]


def get_ip_whois(ip: IpCreate) -> IpwithWhois:
    try:

        info = IPWhois(str(ip.ip)).lookup_whois()["nets"][0].get("name", "")

    except Exception as err:
        print(str(err))
        info = ""
    return IpwithWhois(ip=ip.ip, project_id=ip.project_id, netname=info)
