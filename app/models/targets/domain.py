from sqlalchemy import (Boolean, Column, ForeignKey, Integer, String,
                        UniqueConstraint)
from sqlalchemy.orm import relationship

from app.db.base_class import Base
from app.utils.mixins import TimestampMixin


class Domain(TimestampMixin, Base):
    domain = Column(String, nullable=True)
    ips = relationship(
        "Ip", secondary="ip_domain", back_populates="domains", passive_deletes=True
    )
    whois_org = Column(String, nullable=True)
    subdomains = relationship(
        "Subdomain", cascade="all, delete", back_populates="domain"
    )
    emails = relationship("Email", cascade="all, delete", back_populates="domain")
    endpoints = relationship("Endpoint", cascade="all, delete", back_populates="domain")
    is_approved = Column(Boolean, default=True)
    is_scanned = Column(Boolean, default=False)
    project_id = Column(Integer, ForeignKey("project.id", ondelete="CASCADE"))
    project = relationship("Project", back_populates="domains")
    __table_args__ = (
        UniqueConstraint("domain", "project_id", name="unique_domain"),
        {},
    )
