from sqlalchemy import (Boolean, Column, ForeignKey, Integer, String, Table,
                        UniqueConstraint)
from sqlalchemy.orm import relationship

from app.db.base_class import Base
from app.utils.mixins import TimestampMixin

subdomain_ips = Table(
    "subdomain_ips",
    Base.metadata,
    Column("subdomain_id", Integer, ForeignKey("subdomain.id", ondelete="CASCADE")),
    Column("ip_id", Integer, ForeignKey("ip.id", ondelete="CASCADE")),
)


class Subdomain(TimestampMixin, Base):
    subdomain = Column(String, nullable=True)
    domain_id = Column(Integer, ForeignKey("domain.id", ondelete="CASCADE"))
    domain = relationship("Domain", back_populates="subdomains")
    project_id = Column(Integer, ForeignKey("project.id", ondelete="CASCADE"))
    project = relationship("Project", back_populates="subdomains")
    ips = relationship(
        "Ip", secondary=subdomain_ips, back_populates="subdomains"
    )
    endpoints = relationship(
        "Endpoint", cascade="all, delete", back_populates="subdomain"
    )
    domain = relationship("Domain", back_populates="subdomains")
    is_scanned = Column(Boolean, default=False)
    project_id = Column(Integer, ForeignKey("project.id", ondelete="CASCADE"))
    project = relationship("Project", back_populates="subdomains")
    __table_args__ = (
        UniqueConstraint("subdomain", "project_id", name="unique_subdomain"),
        {},
    )
